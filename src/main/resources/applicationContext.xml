<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jpa="http://www.springframework.org/schema/data/jpa"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/data/jpa
           http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
           http://www.springframework.org/schema/tx
           http://www.springframework.org/schema/tx/spring-tx.xsd">

    <!-- ============================================================ -->
    <!-- YALLA TAWSIL - APPLICATION CONTEXT CONFIGURATION              -->
    <!-- XML-based Dependency Injection configuration                 -->
    <!-- ============================================================ -->

    <!-- ============================================================ -->
    <!-- JPA REPOSITORIES CONFIGURATION                               -->
    <!-- Replaces @Repository annotation                              -->
    <!-- ============================================================ -->
    <jpa:repositories base-package="com.yallatawsil.backend.repository"/>

    <!-- ============================================================ -->
    <!-- TRANSACTION MANAGEMENT                                       -->
    <!-- Enables annotation-based transaction management (@Transactional) -->
    <!-- ============================================================ -->
    <tx:annotation-driven/>

    <!-- ============================================================ -->
    <!-- DISTANCE CALCULATOR SERVICE                                  -->
    <!-- Provides distance computation using the Haversine formula    -->
    <!-- ============================================================ -->
    <bean id="distanceCalculator"
          class="com.yallatawsil.backend.service.distance.HaversineDistanceCalculator"/>

    <!-- ============================================================ -->
    <!-- TOUR OPTIMIZERS (Strategy Pattern Implementations)           -->
    <!-- ============================================================ -->
    <bean id="nearestNeighborOptimizer"
          class="com.yallatawsil.backend.service.optimizer.NearestNeighborOptimizer">
        <constructor-arg ref="distanceCalculator"/>
    </bean>

    <bean id="clarkeWrightOptimizer"
          class="com.yallatawsil.backend.service.optimizer.ClarkeWrightOptimizer">
        <constructor-arg ref="distanceCalculator"/>
    </bean>

    <!-- ============================================================ -->
    <!-- MAPPERS (DTO <-> ENTITY Conversion Layer)                    -->
    <!-- ============================================================ -->
    <bean id="vehicleMapper"
          class="com.yallatawsil.backend.mapper.VehicleMapperImpl"/>

    <bean id="warehouseMapper"
          class="com.yallatawsil.backend.mapper.WarehouseMapperImpl"/>

    <bean id="deliveryMapper"
          class="com.yallatawsil.backend.mapper.DeliveryMapperImpl"/>

    <bean id="tourMapper"
          class="com.yallatawsil.backend.mapper.TourMapperImpl">
        <constructor-arg ref="deliveryMapper"/>
        <constructor-arg ref="vehicleMapper"/>
        <constructor-arg ref="warehouseMapper"/>
    </bean>

    <!-- ============================================================ -->
    <!-- SERVICE LAYER                                                -->
    <!-- Contains business logic implementations                      -->
    <!-- ============================================================ -->

    <!-- Vehicle Service -->
    <bean id="vehicleService"
          class="com.yallatawsil.backend.service.VehicleServiceImpl">
        <constructor-arg ref="vehicleRepository"/>
        <constructor-arg ref="vehicleMapper"/>
        <constructor-arg ref="tourRepository"/>
    </bean>

    <!-- Warehouse Service -->
    <bean id="warehouseService"
          class="com.yallatawsil.backend.service.WarehouseServiceImpl">
        <constructor-arg ref="warehouseRepository"/>
        <constructor-arg ref="warehouseMapper"/>
    </bean>

    <!-- Delivery Service -->
    <bean id="deliveryService"
          class="com.yallatawsil.backend.service.DeliveryServiceImpl">
        <constructor-arg ref="deliveryRepository"/>
        <constructor-arg ref="deliveryMapper"/>
    </bean>

    <!-- Tour Service (Main business logic - Strategy pattern included) -->
    <bean id="tourService"
          class="com.yallatawsil.backend.service.TourServiceImpl">
        <constructor-arg ref="tourRepository"/>
        <constructor-arg ref="vehicleRepository"/>
        <constructor-arg ref="warehouseRepository"/>
        <constructor-arg ref="deliveryRepository"/>
        <constructor-arg ref="tourMapper"/>
        <constructor-arg ref="distanceCalculator"/>
        <!-- Strategy pattern: mapping optimizer strategies by key -->
        <constructor-arg>
            <map>
                <entry key="NEAREST_NEIGHBOR" value-ref="nearestNeighborOptimizer"/>
                <entry key="CLARKE_WRIGHT" value-ref="clarkeWrightOptimizer"/>
            </map>
        </constructor-arg>
    </bean>

    <!-- ============================================================ -->
    <!-- CONTROLLER LAYER                                             -->
    <!-- Exposes REST endpoints for each domain                       -->
    <!-- ============================================================ -->

    <!-- Vehicle Controller -->
    <bean id="vehicleController"
          class="com.yallatawsil.backend.controller.VehicleController">
        <constructor-arg ref="vehicleService"/>
    </bean>

    <!-- Warehouse Controller -->
    <bean id="warehouseController"
          class="com.yallatawsil.backend.controller.WarehouseController">
        <constructor-arg ref="warehouseService"/>
    </bean>

    <!-- Delivery Controller -->
    <bean id="deliveryController"
          class="com.yallatawsil.backend.controller.DeliveryController">
        <constructor-arg ref="deliveryService"/>
    </bean>

    <!-- Tour Controller -->
    <bean id="tourController"
          class="com.yallatawsil.backend.controller.TourController">
        <constructor-arg ref="tourService"/>
    </bean>

</beans>
